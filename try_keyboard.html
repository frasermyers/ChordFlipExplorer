<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Piano Keyboard with SVG</title>
  <style>
  </style>
</head>
<body>

  <div style="margin-left: 50px; margin-bottom:50px">
    <h1> Try keyboard </h1>
    <button onclick="buttonPushed(event);" style="margin-right:10px">Random chord</button>
  </div>

  <div style="margin-left:50px">
    <svg id="pianoSVG" width="1600" height="250" >
    </svg>
    <h1 id="chord-name"> </h1>
  </div>

  <script>
    const xmlns = "http://www.w3.org/2000/svg";
    const svg = document.getElementById('pianoSVG');

    const f =  0.2; // Size factor
    const numOctaves = 4; // num octaves

    // key sizes
    const whiteKeyWidth = 67 * f;
    const whiteKeyHeight = 236 * f;
    const blackKeyWidth = 36 * f;
    const blackKeyHeight = 136 * f;

    const numWhiteKeys = numOctaves * 7;
    const blackKeyOffsets = [0, 1, 3, 4, 5]; // Positions of black keys relative to white keys (C#, D#, F#, G#, A#)
    var allKeys = [];
    var auds = {};
    var chromaticScale = ["C", "Cs", "D", "Eb", "E", "F", "Fs", "G", "Ab", "A", "Bb", "B"];

    window.onload = function() {
      chromaticScale.forEach((key) => {
           // Load chord wavs
           var aud = new Audio("triads/" + key + "_maj_5_0.wav"); //#t=0.0,0.5")
           auds[key] = aud;
           aud = new Audio("triads/" + key + "_min_5_0.wav"); //#t=0.0,0.5")
           auds[key + "m"] = aud;
      });
       drawPiano();
    }

    function isWhiteKey(k) {
      return (k.attributes['key-type'].value == 'white');

     }


     function createWhiteKey(whiteKeyNum, absoluteKeyNum) {

        const whiteKey = document.createElementNS(xmlns, "rect");

        whiteKey.setAttribute('x', whiteKeyNum * whiteKeyWidth);
        whiteKey.setAttribute('y', 0);
        whiteKey.setAttribute('width', whiteKeyWidth);
        whiteKey.setAttribute('height', whiteKeyHeight);
        whiteKey.setAttribute('fill', 'white');
        whiteKey.setAttribute('stroke', 'black');
        whiteKey.setAttribute('key-type', 'white');
        whiteKey.setAttribute("note-name", chromaticScale[absoluteKeyNum % chromaticScale.length]);
        whiteKey.addEventListener("click", keyClicked);

        return whiteKey;
     }

     function createBlackKey(whiteKeyNum, absoluteKeyNum) {

          const blackKey = document.createElementNS(xmlns, "rect");

          const blackKeyX = ((whiteKeyNum+1) * whiteKeyWidth) - (blackKeyWidth / 2);
          blackKey.setAttribute('x', blackKeyX);
          blackKey.setAttribute('y', 0);
          blackKey.setAttribute('width', blackKeyWidth);
          blackKey.setAttribute('height', blackKeyHeight);
          blackKey.setAttribute('fill', '#b8b8b8');
          blackKey.setAttribute('stroke', 'black');
          blackKey.setAttribute('stroke-width', '1');
          blackKey.setAttribute('key-type', 'black');
          blackKey.setAttribute("note-name", chromaticScale[absoluteKeyNum % chromaticScale.length]);
          blackKey.addEventListener("click", keyClicked);
          return blackKey;
     }


    function drawPiano() {


      for (var i = 0; i < numWhiteKeys; i++) {
        // create white key

        var whiteKey = createWhiteKey(i, allKeys.length);
        allKeys.push(whiteKey);


       if (blackKeyOffsets.includes(i % 7))
      {
          //If appropriate, create black key

          var blackKey = createBlackKey(i, allKeys.length);
          allKeys.push(blackKey);

       }

      }


      // Append white keys to svg element
       allKeys.forEach((k) => {
           if (isWhiteKey(k)) {
             svg.appendChild(k);
           }

       });

      // Append black keys to svg element (black keys go "on top")
       allKeys.forEach((k) => {
           if (isBlackKey(k)) {
             svg.appendChild(k);
           }

       });


    }


   function playAndShowChord(r, flavour) {
     var flavourNames = ['', 'm'];
     var chordFullName = chromaticScale[r] + flavourNames[flavour];
     auds[chordFullName].play();

     clearHighlights();

     var pos = chordPositions(flavour);
     pos.forEach((p) => {
        allKeys[r+p].setAttribute('fill', 'red');
        allKeys[r+p].setAttribute('stroke', 'black');
      });

     document.getElementById('chord-name').innerHTML = "  " +  chromaticScale[r].replace('s', '#') + flavourNames[flavour];

   }

  function buttonPushed(e) {

     var r = Math.floor(Math.random() * chromaticScale.length);   // pick root note number in chromatic scale
     var flavour = Math.floor(Math.random() * 2);   // pick flavour (major or minor)

     playAndShowChord(r, flavour);

  }


  function keyClicked(event) {
      var noteClicked = event.target.attributes["note-name"].value;
      var r = chromaticScale.indexOf(noteClicked); // get root note number in chromatic scale

      flavour = 0;
      if (pressedKeys[77]) { //  set flavour to minor if "m" key  is pressed down
        flavour = 1;
      }
      playAndShowChord(r, flavour);


  }

  function chordPositions(flavour=0) {
     if (flavour == 1) {
        return [0, 3, 7];
     }
     else {
         return [0, 4, 7];
     }

  }



  function isBlackKey(k) {
      return (k.attributes['key-type'].value == 'black');

  }


  function clearHighlights() {
     allKeys.forEach((k) => {
        if (isWhiteKey(k)) {
          k.setAttribute('fill', k.attributes['key-type'].value);
        }
        else {
          k.setAttribute('fill', '#b8b8b8');
        }
        
        k.setAttribute('stroke', 'black');
     });

  }


  var pressedKeys = {};
  window.onkeyup = function(e) {
    pressedKeys[e.keyCode] = false;
    qq = 1;
  }
  window.onkeydown = function(e) {
    pressedKeys[e.keyCode] = true;
    qq = 1;
  }

  </script>
</body>
</html>
